# QuoteStatus Enum-to-Foreign Key Diagnostic Report

## Problem Summary
When creating or updating a `Quote`, the backend is assigning a Python Enum (`QuoteStatus`) directly to the `status` field, which is an integer foreign key to the `quote_statuses` table. This causes errors like:

```
(psycopg2.ProgrammingError) can't adapt type 'QuoteStatus'
```

---

## Model Definitions
- `Quote.status` is defined as:
  ```python
  status = Column(Integer, ForeignKey("quote_statuses.id"), nullable=False)
  ```
- Enum:
  ```python
  class QuoteStatus(PyEnum):
      DRAFT = 'DRAFT'
      SENT = 'SENT'
      ...
  ```
- Relationship:
  ```python
  status_object = relationship("QuoteStatusModel")
  ```

---

## Incorrect Enum-to-FK Assignments (‚ùå)

- **Quote Creation (POST):**
  ```python
  quote = Quote(..., status=quote_status, ...)
  # quote_status is a QuoteStatus Enum, not an integer ID
  ```
- **Quote Update:**
  ```python
  quote.status = parse_quote_status(status)  # Returns Enum, not integer ID
  ```
- **Quote Duplication:**
  ```python
  new_quote = Quote(..., status=QuoteStatus.DRAFT, ...)
  # Should be integer ID, not Enum
  ```

---

## Correct Usage (‚úÖ)
No correct usage found; all assignments use Enum instead of integer ID.

---

## Suggested Fixes (üîß)

### 1. Always Assign Integer ID
Replace Enum assignments with a DB lookup for the corresponding status ID:

```python
def get_status_id(db, status_enum):
    status_obj = db.query(QuoteStatusModel).filter_by(name=status_enum.value).first()
    if not status_obj:
        raise ValueError(f"Status '{status_enum.value}' not found in quote_statuses table.")
    return status_obj.id
```

**Usage Example:**
```python
quote.status = get_status_id(db, QuoteStatus.DRAFT)
```

### 2. Refactor All Assignments
- In quote creation, update, and duplication, use `get_status_id(db, ...)` instead of passing the Enum directly.

### 3. Ensure DB Seeding
- The `quote_statuses` table must be seeded with all enum values (`DRAFT`, `SENT`, etc.).
- If not, add a migration or seed script to insert these values.

---

## Summary Table
| Location                        | Current Usage                | Correct Usage                |
|----------------------------------|------------------------------|------------------------------|
| Quote Creation (POST)            | `status=quote_status`        | `status=get_status_id(db, quote_status)` |
| Quote Update                     | `quote.status = ...`         | `quote.status = get_status_id(db, ...)`  |
| Quote Duplication                | `status=QuoteStatus.DRAFT`   | `status=get_status_id(db, QuoteStatus.DRAFT)` |

---

## Next Steps
- Refactor all assignments to use the integer ID from the DB.
- Add and use the `get_status_id` helper.
- Ensure the `quote_statuses` table is seeded.

---

*Generated by GitHub Copilot diagnostic audit, July 2025.*

{% extends "base.html" %}

{% block title %}Import Invoices - InvoicePlane Python{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Import Invoices</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/invoices" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Invoices
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Import Legacy Invoice Data</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Import invoice data from the legacy InvoicePlane system. This will import invoices with all their line items,
                    calculations, and totals.
                </p>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> This operation will import data from the legacy SQL file.
                    Make sure you have backed up your current data if needed.
                </div>

                <button id="importBtn" class="btn btn-primary btn-lg" onclick="startImport()">
                    <i class="bi bi-upload"></i> Start Import
                </button>

                <div id="importProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="mt-2 text-muted">Importing invoices... Please wait.</p>
                </div>

                <div id="importResult" class="mt-3" style="display: none;">
                    <div id="importAlert" class="alert"></div>
                    <div id="verificationResult"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Verification</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    After import, verify that all invoices have the required data.
                </p>

                <button id="verifyBtn" class="btn btn-outline-info btn-sm" onclick="verifyImport()">
                    <i class="bi bi-check-circle"></i> Verify Import
                </button>

                <div id="verifyResult" class="mt-3" style="display: none;">
                    <div id="verifyAlert" class="alert"></div>
                    <div id="verifyDetails"></div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    Clean up options before importing.
                </p>

                <button class="btn btn-outline-danger btn-sm" onclick="deleteAllInvoices()">
                    <i class="bi bi-trash"></i> Delete All Invoices
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function startImport() {
    const importBtn = document.getElementById('importBtn');
    const importProgress = document.getElementById('importProgress');
    const importResult = document.getElementById('importResult');

    // Show progress, hide button
    importBtn.style.display = 'none';
    importProgress.style.display = 'block';
    importResult.style.display = 'none';

    try {
        const response = await fetch('/invoices/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        // Hide progress
        importProgress.style.display = 'none';
        importResult.style.display = 'block';

        if (response.ok) {
            showImportResult('success', result);
        } else {
            showImportResult('error', result);
        }

    } catch (error) {
        importProgress.style.display = 'none';
        importResult.style.display = 'block';
        showImportResult('error', { error: error.message });
    }

    // Show button again
    importBtn.style.display = 'block';
}

function showImportResult(type, result) {
    const alertDiv = document.getElementById('importAlert');
    const verificationDiv = document.getElementById('verificationResult');

    if (type === 'success') {
        alertDiv.className = 'alert alert-success';
        alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> Import completed successfully!';

        if (result.verification) {
            verificationDiv.innerHTML = formatVerificationResult(result.verification);
        }
    } else {
        alertDiv.className = 'alert alert-danger';
        alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Import failed: ${result.error || 'Unknown error'}`;

        if (result.stderr) {
            verificationDiv.innerHTML = `<pre class="text-danger small">${result.stderr}</pre>`;
        }
    }
}

async function verifyImport() {
    const verifyBtn = document.getElementById('verifyBtn');
    const verifyResult = document.getElementById('verifyResult');

    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="bi bi-hourglass"></i> Verifying...';

    try {
        const response = await fetch('/invoices/verify-import');
        const result = await response.json();

        verifyResult.style.display = 'block';

        if (response.ok) {
            showVerificationResult(result);
        } else {
            document.getElementById('verifyAlert').className = 'alert alert-danger';
            document.getElementById('verifyAlert').innerHTML = `Verification failed: ${result.detail}`;
        }

    } catch (error) {
        verifyResult.style.display = 'block';
        document.getElementById('verifyAlert').className = 'alert alert-danger';
        document.getElementById('verifyAlert').innerHTML = `Error: ${error.message}`;
    }

    verifyBtn.disabled = false;
    verifyBtn.innerHTML = '<i class="bi bi-check-circle"></i> Verify Import';
}

function showVerificationResult(result) {
    const alertDiv = document.getElementById('verifyAlert');
    const detailsDiv = document.getElementById('verifyDetails');

    if (result.status === 'success') {
        alertDiv.className = 'alert alert-success';
        alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> All invoices verified successfully!';
    } else if (result.status === 'no_invoices') {
        alertDiv.className = 'alert alert-info';
        alertDiv.innerHTML = '<i class="bi bi-info-circle"></i> No invoices found to verify.';
        return;
    } else {
        alertDiv.className = 'alert alert-warning';
        alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Issues found during verification.`;
    }

    detailsDiv.innerHTML = formatVerificationDetails(result);
}

function formatVerificationDetails(result) {
    let html = `
        <div class="row text-center mb-3">
            <div class="col">
                <div class="h4 mb-0">${result.total_invoices}</div>
                <small class="text-muted">Total Invoices</small>
            </div>
            <div class="col">
                <div class="h4 mb-0">${result.invoices_with_items}</div>
                <small class="text-muted">With Items</small>
            </div>
            <div class="col">
                <div class="h4 mb-0">${result.invoices_with_totals}</div>
                <small class="text-muted">With Totals</small>
            </div>
        </div>
    `;

    if (result.issues && result.issues.length > 0) {
        html += '<h6>Issues Found:</h6><ul class="small">';
        result.issues.slice(0, 10).forEach(issue => {
            html += `<li class="text-danger">${issue}</li>`;
        });
        if (result.issues.length > 10) {
            html += `<li class="text-muted">... and ${result.issues.length - 10} more issues</li>`;
        }
        html += '</ul>';
    }

    if (result.sample_invoices && result.sample_invoices.length > 0) {
        html += '<h6>Sample Invoices:</h6>';
        result.sample_invoices.forEach(invoice => {
            const statusIcon = invoice.has_items && invoice.has_totals ? '✅' : '❌';
            html += `<div class="small border rounded p-2 mb-2">
                <strong>${statusIcon} Invoice ${invoice.number}</strong>
                <div>Items: ${invoice.items.length}, Complete: ${invoice.has_items && invoice.has_totals}</div>
            </div>`;
        });
    }

    return html;
}

function formatVerificationResult(verification) {
    let html = '<h6>Import Verification:</h6>';
    html += `<div class="row text-center">
        <div class="col">
            <div class="h5">${verification.total_invoices}</div>
            <small>Total Invoices</small>
        </div>
        <div class="col">
            <div class="h5">${verification.invoices_with_items}</div>
            <small>With Items</small>
        </div>
        <div class="col">
            <div class="h5">${verification.invoices_with_totals}</div>
            <small>With Totals</small>
        </div>
    </div>`;

    if (verification.issues && verification.issues.length > 0) {
        html += '<div class="mt-2"><strong>Issues:</strong><ul class="small mb-0">';
        verification.issues.slice(0, 5).forEach(issue => {
            html += `<li class="text-warning">${issue}</li>`;
        });
        html += '</ul></div>';
    }

    return html;
}

async function deleteAllInvoices() {
    if (!confirm('Are you sure you want to delete ALL invoices? This action cannot be undone!')) {
        return;
    }

    if (!confirm('This will permanently delete all invoices and their items. Are you absolutely sure?')) {
        return;
    }

    try {
        // For now, redirect to run the script manually
        // In a production environment, you'd want to implement this as a web endpoint
        alert('Please run the deletion script manually: python delete_all_invoices.py');
        window.open('/invoices', '_blank');

    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}
</script>
{% endblock %}
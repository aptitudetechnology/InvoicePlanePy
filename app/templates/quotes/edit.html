let itemCounter = {{ (quote.items|length) if quote.items else 0 }};
let taxRates = []; // Will be populated from database
let products = []; // Will be populated from API

// Load tax rates from database
async function loadTaxRates() {
    try {
        const response = await fetch('/tax_rates/api');
        if (!response.ok) throw new Error('Failed to load tax rates');
        const data = await response.json();
        taxRates = data.tax_rates || data;
        
        // Populate all existing tax rate dropdowns
        populateAllTaxRateDropdowns();
    } catch (error) {
        console.error('Error loading tax rates:', error);
        // Fallback to empty array if server fails
        taxRates = [];
    }
}

// Load products from API
async function loadProducts() {
    try {
        const response = await fetch('/products/api');
        if (!response.ok) throw new Error('Failed to load products');
        const data = await response.json();
        products = data.products || data;
    } catch (error) {
        console.error('Error loading products:', error);
        products = [];
    }
}

// Populate all tax rate dropdowns with current tax rates
function populateAllTaxRateDropdowns() {
    const taxRateSelects = document.querySelectorAll('.tax-rate-select');
    taxRateSelects.forEach(select => {
        populateTaxRateDropdown(select);
    });
}

// Populate a single tax rate dropdown
function populateTaxRateDropdown(selectElement) {
    const currentValue = selectElement.value;
    
    // Clear existing options except the "None" option
    selectElement.innerHTML = '<option value="0">None (0%)</option>';
    
    // Add tax rates from database
    taxRates.forEach(taxRate => {
        const option = document.createElement('option');
        option.value = taxRate.rate;
        option.textContent = `${taxRate.name} (${taxRate.rate.toFixed(2)}%)`;
        option.setAttribute('data-tax-id', taxRate.id);
        selectElement.appendChild(option);
    });
    
    // Restore selected value
    selectElement.value = currentValue;
}

// Create tax rate dropdown HTML for new rows
function createTaxRateDropdownHTML(itemIndex, selectedRate = 0) {
    let optionsHTML = '<option value="0">None (0%)</option>';
    
    taxRates.forEach(function(taxRate) {
        const selected = taxRate.rate == selectedRate ? 'selected' : '';
        optionsHTML += `<option value="${taxRate.rate}" data-tax-id="${taxRate.id}" ${selected}>${taxRate.name} (${taxRate.rate.toFixed(2)}%)</option>`;
    });
    
    return `<select class="form-select form-select-sm tax-rate-select" name="items[${itemIndex}][tax_rate]" onchange="calculateItemTotal(this)">${optionsHTML}</select>`;
}

function addNewRow() {
    const tbody = document.getElementById('quote-items');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="items[${itemCounter}][name]" placeholder="Item">
            <textarea class="form-control form-control-sm mt-1" name="items[${itemCounter}][description]" rows="2" placeholder="Description"></textarea>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][quantity]" value="1" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][price]" value="0.00" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][discount]" value="0.00" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            ${createTaxRateDropdownHTML(itemCounter)}
        </td>
        <td class="item-subtotal">$0.00</td>
        <td class="item-discount-amount">$0.00</td>
        <td class="item-tax-amount">$0.00</td>
        <td class="item-total">$0.00</td>
    `;
    tbody.appendChild(newRow);
    itemCounter++;
}

function removeItem(button) {
    const row = button.closest('tr');
    row.remove();
    calculateTotals();
}

function calculateItemTotal(input) {
    const row = input.closest('tr');
    const quantity = parseFloat(row.querySelector('input[name*="[quantity]"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name*="[price]"]').value) || 0;
    const discount = parseFloat(row.querySelector('input[name*="[discount]"]').value) || 0;
    const taxRate = parseFloat(row.querySelector('select[name*="[tax_rate]"]').value) || 0;
    
    const subtotal = quantity * price;
    const discountAmount = subtotal * (discount / 100);
    const taxableAmount = subtotal - discountAmount;
    const taxAmount = taxableAmount * (taxRate / 100);
    const total = taxableAmount + taxAmount;
    
    row.querySelector('.item-subtotal').textContent = `$${subtotal.toFixed(2)}`;
    row.querySelector('.item-discount-amount').textContent = `$${discountAmount.toFixed(2)}`;
    row.querySelector('.item-tax-amount').textContent = `$${taxAmount.toFixed(2)}`;
    row.querySelector('.item-total').textContent = `$${total.toFixed(2)}`;
    
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let itemTax = 0;
    let totalDiscount = 0;
    
    document.querySelectorAll('#quote-items tr').forEach(row => {
        const itemSubtotal = parseFloat(row.querySelector('.item-subtotal').textContent.replace('$', '')) || 0;
        const itemDiscountAmount = parseFloat(row.querySelector('.item-discount-amount').textContent.replace('$', '')) || 0;
        const itemTaxAmount = parseFloat(row.querySelector('.item-tax-amount').textContent.replace('$', '')) || 0;
        
        subtotal += itemSubtotal;
        totalDiscount += itemDiscountAmount;
        itemTax += itemTaxAmount;
    });
    
    const discountPercentage = parseFloat(document.querySelector('input[name="discount_percentage"]').value) || 0;
    const additionalDiscount = (subtotal - totalDiscount) * (discountPercentage / 100);
    const quoteTax = 0; // This would need to be calculated based on your business logic
    
    const total = subtotal - totalDiscount - additionalDiscount + itemTax + quoteTax;
    
    document.getElementById('quote-subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('quote-item-tax').textContent = `$${itemTax.toFixed(2)}`;
    document.getElementById('quote-tax').textContent = `$${quoteTax.toFixed(2)}`;
    document.getElementById('quote-total').textContent = `$${total.toFixed(2)}`;
}

// Product selection functions
function addProduct() {
    if (products.length === 0) {
        loadProducts().then(() => {
            displayProductModal();
        });
    } else {
        displayProductModal();
    }
}

function displayProductModal() {
    const productList = document.getElementById('productList');
    productList.innerHTML = '';
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'col-md-6 mb-3';
        productCard.innerHTML = `
            <div class="card product-card" style="cursor: pointer;" onclick="selectProduct(${product.id})">
                <div class="card-body">
                    <h6 class="card-title">${product.name}</h6>
                    <p class="card-text text-muted small">${product.description || 'No description'}</p>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold text-success">$${parseFloat(product.price || 0).toFixed(2)}</span>
                        <small class="text-muted">SKU: ${product.sku || 'N/A'}</small>
                    </div>
                </div>
            </div>
        `;
        productList.appendChild(productCard);
    });
    
    // Show modal (Bootstrap 5 syntax)
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

function selectProduct(productId) {
    const selectedProduct = products.find(p => p.id === productId);
    if (!selectedProduct) return;
    
    // Add product as new row
    const tbody = document.getElementById('quote-items');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" name="items[${itemCounter}][name]" value="${selectedProduct.name}" placeholder="Item">
            <textarea class="form-control form-control-sm mt-1" name="items[${itemCounter}][description]" rows="2" placeholder="Description">${selectedProduct.description || ''}</textarea>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][quantity]" value="1" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][price]" value="${parseFloat(selectedProduct.price || 0).toFixed(2)}" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items[${itemCounter}][discount]" value="0.00" step="0.01" onchange="calculateItemTotal(this)">
        </td>
        <td>
            ${createTaxRateDropdownHTML(itemCounter)}
        </td>
        <td class="item-subtotal">$${parseFloat(selectedProduct.price || 0).toFixed(2)}</td>
        <td class="item-discount-amount">$0.00</td>
        <td class="item-tax-amount">$0.00</td>
        <td class="item-total">$${parseFloat(selectedProduct.price || 0).toFixed(2)}</td>
    `;
    tbody.appendChild(newRow);
    itemCounter++;
    
    // Calculate totals
    calculateTotals();
    
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    modal.hide();
}

function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const productCards = document.querySelectorAll('.product-card');
    
    productCards.forEach(card => {
        const productName = card.querySelector('.card-title').textContent.toLowerCase();
        const productDescription = card.querySelector('.card-text').textContent.toLowerCase();
        
        if (productName.includes(searchTerm) || productDescription.includes(searchTerm)) {
            card.closest('.col-md-6').style.display = 'block';
        } else {
            card.closest('.col-md-6').style.display = 'none';
        }
    });
}

function addQuoteTax() {
    // Implement add quote tax functionality
    console.log('Add Quote Tax clicked');
}

function downloadPDF() {
    window.location.href = '/quotes/{{ quote.id }}/pdf';
}

function sendEmail() {
    window.location.href = '/quotes/{{ quote.id }}/email';
}

function quoteToInvoice() {
    if (confirm('Convert this quote to an invoice?')) {
        window.location.href = '/quotes/{{ quote.id }}/convert-to-invoice';
    }
}

function copyQuote() {
    if (confirm('Create a copy of this quote?')) {
        window.location.href = '/quotes/{{ quote.id }}/copy';
    }
}

function deleteQuote() {
    if (confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
        fetch('/quotes/{{ quote.id }}/delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/quotes';
            } else {
                alert('Error deleting quote');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting quote');
        });
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load tax rates first, then calculate totals
    loadTaxRates().then(() => {
        calculateTotals();
    });
    
    // Load products for later use
    loadProducts();
});